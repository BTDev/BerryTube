/*
 jQuery Multiple Select Box Plugin 0.8.1

 http://plugins.jquery.com/jQueryMultipleSelectBox/
 http://code.google.com/p/jquerymultipleselectbox/

 Apache License 2.0 - http://www.apache.org/licenses/LICENSE-2.0

 @author Dreamltf
 @date 2013/09/07

 Depends: jquery.js(1.2+), multipleselectbox.css
*/
(function(f){function q(a,b){if(null!=a)for(var c=b.length-1;0<=c;c--)a.unbind(b[c]+"."+g);return a}function u(a,b,c){var d=b.getMultipleSelectBoxOptions();if(null==d.onSelectStart)return!0;a=d.onSelectStart.apply(b[0],[a,c]);return"boolean"!=typeof a||a}function x(a,b){var c=a.getMultipleSelectBoxCachedRows();b-=1;return 0>b||b>=c.length?-1:c.eq(b).isMultipleSelectBoxRowSelectable()?b:x(a,b)}function y(a,b){var c=a.getMultipleSelectBoxCachedRows();b+=1;return 0>b||b>=c.length?-1:c.eq(b).isMultipleSelectBoxRowSelectable()?
b:y(a,b)}function A(a,b,c){var d=a.getMultipleSelectBoxCachedRows(),e=d.length;if(0>b||0>c||b>=e||c>=e)return null;var h=a.getMultipleSelectBoxOptions(),n=a.getMultipleSelectBoxViewport(),f=n.getScrollTop(),g=n.getHeight(),k=0<e?d.eq(0).getMultipleSelectBoxViewport():null,l=d.eq(c).getMultipleSelectBoxViewport(),d=l.getTopPos(k),e=l.getBottomPos(k);h.isHorizontalMode&&(f=n.getScrollLeft(),g=n.getWidth(),d=l.getLeftPos(k),e=l.getRightPos(k));a=a.getMultipleSelectBoxHistory().selectingCurrentIndex;
h=null;if(b<c||b==c&&0<=a&&a<c){if(e<f||e-g>f)h=e-g}else if(b>c||b==c&&(0>a||a>c))if(d<f||d+g<f)h=d;return h}function B(a){var b=f(document);a.bind("mousedown."+g,function(c){c.preventDefault();var d=c.target,e=f(d),h=e;if(d!=this){e.parent()[0]!=this?(d.focus(),h=e.parents("."+g+">*").eq(0)):this.focus();var n=h.getMultipleSelectBoxRowIndex(a),d=n;if(u(c,a,n)){var r=a.getMultipleSelectBoxOptions(),e=a.getMultipleSelectBoxHistory(),z=h=r.isTouchDeviceMode,k=h;r.isKeyEventEnabled&&(c.shiftKey?(d=n,
n=e.selectingStartIndex):c.ctrlKey&&(z=k=!0));a.addClass(m).drawMultipleSelectBox(n,d,{isSelectionOpposite:z,isSelectionRetained:k,scrollPos:null});var l=function(b){r.scrollHelper(b,a,n,k)};a.yieldMultipleSelectBox().bind("mouseenter."+g,function(){q(b,["mousemove"])}).bind("mouseleave."+g,function(a){l(a);b.bind("mousemove."+g,function(a){l(a)})}).bind("mouseover."+g,function(a){l(a)}).one("mouseup."+g,function(a){l(a)});C&&b.bind("mouseleave."+g,function(){b.one("mousemove."+g,function(a){a.button||
t(a)})})}}});a.getMultipleSelectBoxCachedRows().filter("."+v).bind("dblclick."+g,function(b){var d=f(this);if(u(b,a,d.getMultipleSelectBoxRowIndex(a))){var e=a.getMultipleSelectBoxOptions().maxLimit,d=d.getMultipleSelectBoxOptGroupItems(),h=d.length;0<h&&(0<e&&h>e&&(h=e),a.drawMultipleSelectBox(d.eq(0).getMultipleSelectBoxRowIndex(a),d.eq(h-1).getMultipleSelectBoxRowIndex(a),{scrollPos:null}),a.addClass(m),t(b))}})}function D(a){a.bind("keydown."+g,function(b){if(b.target==this){var c=b.keyCode;if(37<=
c&&40>=c||32==c){var d=a.getMultipleSelectBoxHistory().selectingCurrentIndex,e=!1,h=b.shiftKey;37==c||38==c?d=x(a,d):39==c||40==c?d=y(a,d):32==c&&(e=!0);if(u(b,a,d))return a.addClass(m).drawMultipleSelectBox(d,d,{isSelectionOpposite:e,isSelectionRetained:h}),t(b),!1}}})}function E(a){a.bind("touchstart."+g,function(b){var c=a.getMultipleSelectBoxOptions(),d=a.getMultipleSelectBoxViewport();b=b.originalEvent.touches[0];var e=b.pageY,h=d.getScrollTop();c.isHorizontalMode&&(e=b.pageX,h=d.getScrollLeft());
a.yieldMultipleSelectBox().bind("touchmove."+g,function(b){b.preventDefault();b=b.originalEvent.touches[0];c.isHorizontalMode?a.scrollLeft(h+(b.pageX-e)):a.scrollTop(h+(b.pageY-e))})})}function F(a){var b=a.getMultipleSelectBoxOptions();b.isMouseEventEnabled&&B(a);b.isKeyEventEnabled&&D(a);b.isTouchDeviceMode&&E(a);b.isPopupMode&&null!=b.submitField&&b.submitField.bind("click."+g,function(){a.slideDown("slow")});return a}function t(a){return f("."+g).yieldMultipleSelectBox().each(function(){var b=
f(this),c=b.getMultipleSelectBoxOptions(),d=b.getMultipleSelectBoxHistory();if(b.isMultipleSelectBoxSelecting()){b.removeClass(m);var e=b.getMultipleSelectBoxSelectedRows();c.isPopupMode&&b.slideUp("slow");b.trigger("mouseup."+g);null!=c.onSelectEnd&&c.onSelectEnd.apply(b[0],[a,e,d.selectingStartIndex,d.selectingCurrentIndex,d.selectedStartIndex,d.selectedCurrentIndex]);null==c.onSelectChange||null!=d.selectedRows&&0==d.selectedRows.not(e).length&&0==e.not(d.selectedRows).length||c.onSelectChange.apply(b[0],
[a,e,d.selectedRows,d.selectingStartIndex,d.selectingCurrentIndex,d.selectedStartIndex,d.selectedCurrentIndex]);null!=c.submitField&&c.submitField.val(b.serializeMultipleSelectBox());d.selectedRows=e}d.selectedStartIndex=d.selectingStartIndex;d.selectedCurrentIndex=d.selectingCurrentIndex})}function G(a,b,c,d){if("mouseover"==a.type)a=f(a.target),b[0]==a.parent()[0]&&(p.stopTimer(),b.drawMultipleSelectBox(c,a.getMultipleSelectBoxRowIndex(b),{isSelectionRetained:d,scrollPos:null}));else if("mouseup"==
a.type)p.stopTimer();else if("mouseleave"!=a.type&&"mousemove"==a.type){var e=b.getMultipleSelectBoxOptions(),h=e.isHorizontalMode;p.mousePos=h?a.pageX:a.pageY;p.startTimer(function(){var a=b.getMultipleSelectBoxViewport(),f=a.getTopPos(),g=a.getBottomPos(),k=a.getScrollTop(),l=a.getHeight();h&&(f=a.getLeftPos(),g=a.getRightPos(),k=a.getScrollLeft(),l=a.getWidth());var k=a=k,m=e.scrollSpeed,s=p.mousePos;s<f?k=a-=m:s>g&&(a+=m,k=a+l);b.drawMultipleSelectBox(c,H(b,k),{isSelectionRetained:d,scrollPos:a})},
100)}}function H(a,b){if(0>=b)return 0;var c=a.getMultipleSelectBoxHistory().selectingCurrentIndex;if(null==c||0>c)return-1;var d=a.getMultipleSelectBoxOptions().isHorizontalMode,e=a.getMultipleSelectBoxViewport(),h=d?e.getScrollWidth():e.getScrollHeight(),e=a.getMultipleSelectBoxCachedRows(),f=e.length;if(b>=h)return f-1;var h=0<f?e.eq(0).getMultipleSelectBoxViewport():null,g=w(e.eq(c).getMultipleSelectBoxViewport(),h,d,b),m=c;if(0<g)for(c-=1;0<=c;c--){if(0==w(e.eq(c).getMultipleSelectBoxViewport(),
h,d,b)){m=c;break}}else if(0>g)for(c+=1;c<f;c++)if(0==w(e.eq(c).getMultipleSelectBoxViewport(),h,d,b)){m=c;break}return m}function w(a,b,c,d){var e=a.getTopPos(b),f=a.getBottomPos(b);c&&(e=a.getLeftPos(b),f=a.getRightPos(b));a=0;e>d?a=1:f<d&&(a=-1);return a}var g="MultipleSelectBox",m="selecting",v="optgroup",I={maxLimit:-1,scrollSpeed:50,isHorizontalMode:!1,isPopupMode:!1,isTouchDeviceMode:"auto",isMouseEventEnabled:!0,isKeyEventEnabled:!0,submitField:null,onCreate:null,onSelectStart:null,onSelectEnd:null,
onSelectChange:null,scrollHelper:null},C=/msie/.test(navigator.userAgent.toLowerCase());f.extend(f.fn,{multipleSelectBox:function(a){a=f.extend({},I,a);"auto"==a.isTouchDeviceMode&&(a.isTouchDeviceMode=!!("ontouchstart"in window));null==a.scrollHelper&&(a.scrollHelper=G);return this.each(function(){var b=f(this);b.destroyMultipleSelectBox();b.addClass(g).addClass(a.isHorizontalMode?"horizontal":"vertical");a.isPopupMode&&b.addClass("popup");b.css({userSelect:"none",KhtmlUserSelect:"none",MozUserSelect:"none",
WebkitUserSelect:"none"}).attr({unselectable:"on",tabindex:0}).bind("selectstart."+g,function(a){a.preventDefault();return!1});b.data("options",a);var c=a.submitField;if(null!=c&&"string"==typeof c){var d=f("input[name="+c+"]");a.submitField=0<d.length?d:f("<input type='hidden' name='"+c+"'/>").insertAfter(b)}F(b);null!=a.onCreate&&b.bind("onCreate."+g,a.onCreate);null!=a.onSelectStart&&b.bind("onSelectStart."+g,a.onSelectStart);null!=a.onSelectEnd&&b.bind("onSelectEnd."+g,a.onSelectEnd);null!=a.onSelectChange&&
b.bind("onSelectChange."+g,a.onSelectChange);null!=a.onCreate&&a.onCreate.apply(b[0])})},getMultipleSelectBoxCachedRows:function(a){return this.pushStack(f.map(this,function(b){b=f(b);var c=b.data("rows");null==c&&(c=b.children(),b.data("rows",c));null!=a&&(c=c.filter(a));return c.get()}))},clearMultipleSelectBoxCachedRows:function(){return this.removeData("rows")},getMultipleSelectBoxSelectedRows:function(){return f.grep(this.getMultipleSelectBoxCachedRows(),function(a){a=f(a);return a.isMultipleSelectBoxRowSelectable()&&
a.isMultipleSelectBoxRowSelected()})},getMultipleSelectBoxOptGroupItems:function(a){return this.pushStack(f.map(this,function(b){b=f(b);for(var c=[],d=b;0<(d=d.next()).length&&d.isMultipleSelectBoxRowOptGroupItem();)c.push(d[0]);null!=a&&(c=b.pushStack(c).filter(a).get());return c}))},getMultipleSelectBoxRowIndex:function(a){null==a&&(a=this.parent());return a.getMultipleSelectBoxCachedRows().index(this)},getMultipleSelectBoxOptions:function(){return this.data("options")},getMultipleSelectBoxHistory:function(a){var b=
this.data("history");if(a||null==b)b={selectingStartIndex:-1,selectingCurrentIndex:-1,selectedStartIndex:-1,selectedCurrentIndex:-1,selectedRows:null},this.data("history",b);return b},drawMultipleSelectBox:function(a,b,c){c=f.extend({isSelectionOpposite:!1,isSelectionRetained:!1,scrollPos:-1},c);return this.each(function(){var d=f(this),e=d.getMultipleSelectBoxCachedRows(),h=e.length,g=d.getMultipleSelectBoxOptions(),r=g.maxLimit;if(!(0>a||0>b||a>=h||b>=h||0==r||!e.eq(a).isMultipleSelectBoxRowSelectable())){var q=
Math.min(a,b),k=Math.max(a,b),l=[],p=[],s=0;e.each(function(a){var b=f(this);b.isMultipleSelectBoxSelecting()&&b.removeClass(m);if(b.isMultipleSelectBoxRowSelectable()){var d=b.isMultipleSelectBoxRowSelected();q<=a&&a<=k?d?c.isSelectionOpposite?l.push(b):s++:p.push(b):d&&(c.isSelectionRetained?s++:l.push(b))}});h=p.length;if(!(0<r&&h+s>r)){e.eq(b).addClass(m);for(e=l.length-1;0<=e;e--)l[e].removeClass("selected");for(e=h-1;0<=e;e--)p[e].addClass("selected");e=c.scrollPos;null!=e&&(0>e&&(e=A(d,a,b)),
null!=e&&0<=e&&(g.isHorizontalMode?d.scrollLeft(e):d.scrollTop(e)));d=d.getMultipleSelectBoxHistory();d.selectingStartIndex=a;d.selectingCurrentIndex=b}}})},serializeMultipleSelectBoxArray:function(){return f.map(this.getMultipleSelectBoxSelectedRows(),function(a){var b=f(a);a=b.is("[value-render]")?a.getAttribute("value-render"):b.text();return f.trim(a)})},serializeMultipleSelectBox:function(a){return this.serializeMultipleSelectBoxArray().join(null==a?",":a)},yieldMultipleSelectBox:function(){q(f(document),
["mouseleave","mousemove"]);return q(this,["mouseenter","mouseleave","mouseover","touchmove"])},destroyMultipleSelectBox:function(){return this.yieldMultipleSelectBox().each(function(){var a=f(this);a.getMultipleSelectBoxOptions();q(a,"selectstart mousedown mouseup keydown touchstart onCreate onSelectStart onSelectEnd onSelectChange".split(" "));q(a.getMultipleSelectBoxCachedRows(),["dblclick"]);a.removeData("history").removeData("rows").removeData("options")})},isMultipleSelectBoxSelecting:function(){return this.hasClass(m)},
isMultipleSelectBoxRowDisabled:function(){return this.hasClass("disabled")},isMultipleSelectBoxRowSelected:function(){return this.hasClass("selected")},isMultipleSelectBoxRowSelecting:function(){return this.hasClass(m)},isMultipleSelectBoxRowOptGroup:function(){return this.hasClass(v)},isMultipleSelectBoxRowOptGroupItem:function(){return this.hasClass("optgroupitem")},isMultipleSelectBoxRowSelectable:function(){return!this.isMultipleSelectBoxRowDisabled()&&!this.isMultipleSelectBoxRowOptGroup()},
selectMultipleSelectBoxRow:function(){return this.filter(":not(.disabled,."+v+")").addClass("selected")},unselectMultipleSelectBoxRow:function(){return this.removeClass("selected "+m)},selectAllMultipleSelectBoxRows:function(){this.getMultipleSelectBoxCachedRows().selectMultipleSelectBoxRow();return this},unselectAllMultipleSelectBoxRows:function(){this.getMultipleSelectBoxCachedRows().unselectMultipleSelectBoxRow();return this},enableMultipleSelectBoxRow:function(){return this.removeClass("disabled")},
disableMultipleSelectBoxRow:function(){return this.addClass("disabled")},getMultipleSelectBoxViewport:function(){var a=this,b=a[0],c=a.offset();return{getScrollLeft:function(){return a.scrollLeft()},getScrollTop:function(){return a.scrollTop()},getWidth:function(b){return b?a.outerWidth():a.innerWidth()},getHeight:function(b){return b?a.outerHeight():a.innerHeight()},getScrollWidth:function(){return b.scrollWidth},getScrollHeight:function(){return b.scrollHeight},getLeftPos:function(a){return c.left-
(null!=a?a.getLeftPos():0)},getTopPos:function(a){return c.top-(null!=a?a.getTopPos():0)},getRightPos:function(a){return this.getLeftPos(a)+this.getWidth(!0)},getBottomPos:function(a){return this.getTopPos(a)+this.getHeight(!0)}}}});var p={mousePos:0,scrollTimer:null,startTimer:function(a,b){null==this.scrollTimer&&null!=a&&(this.scrollTimer=setInterval(function(){a()},b))},stopTimer:function(){null!=this.scrollTimer&&(clearInterval(this.scrollTimer),this.scrollTimer=null)}};f(document).bind("mouseup."+
g,function(a){t(a)})})(jQuery);
