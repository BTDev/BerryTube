BerryTube
=========

Before running for the first time
---------------------------------

Run `git submodule update --init --remote` to pull in berrymotes.

Download [the emote data](https://cdn.berrytube.tv/berrymotes/data/berrymotes_json_data.json) and place it in `berrymotes/data/`. Avoid running the scraper, so that Reddit doesn't get mad at us.

Copy `.env.sample` to `.env` and tweak the values. All the domains themselves and the main domain prefixed with www. must point to the server.

Run `docker volume create caddy` to create a shared volume for storing certificates. This can be shared across multiple instances to prevent hitting Let's Encrypt rate limits.


Certificate options
-------------------

* `TLS_TYPE=self_signed`

  The default option. Uses self-signed certificates generated by Caddy on startup.

* `TLS_TYPE=http`

  Caddy automatically gets certificates from Let's Encrypt. Requires `CA_EMAIL` and `HTTP_PORT=80`. Remove "-staging" from `CA_URL` to get globally trusted certs once you have verified everything is working properly.

* `TLS_TYPE=cloudflare`

  Same as above, but uses the DNS challenge. Requires `CA_EMAIL`, `CLOUDFLARE_EMAIL` and `CLOUDFLARE_API_KEY`.

* `TLS_TYPE=existing`

  Set `EXISTING_CERT_DIR` to a directory on the host containing .pem files, each having the full public key chain and the private key for a domain.


Running
-------

To run (or apply changes): `docker-compose up -d --build`

To stop and remove containers (keeps data): `docker-compose down`

Note that the `web` directory is mounted directly into the containers (as read-only), so any changes there will get applied immediately.


Database
--------

The database is placed in a docker volume. To get an SQL prompt, run `docker exec -it berrytube_mysql_1 mysql -uberrytube -pberrytube berrytube`.
