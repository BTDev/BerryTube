version: '2'

networks:
    net:

volumes:
    caddy:
    mysql:

services:
    caddy:
        build: ./docker/caddy/
        image: registry.gitlab.com/berrytube/berrytube/caddy:latest
        command: caddy -agree -log stderr -ca "${CA_URL}" -email "${CA_EMAIL}"
        restart: always
        environment:
            - DOMAIN
            - CDN_DOMAIN
            - SOCKET_DOMAIN
            - HTTP_PORT
            - HTTPS_PORT
            - LEGACY_SOCKET_PORT
        volumes:
            - caddy:/root/.caddy
            - ./web:/var/www/html/web:ro
            - ./berrymotes/data:/var/www/html/berrymotes/data:ro
            - ./berrymotes/css:/var/www/html/berrymotes/css:ro
            - ./berrymotes/js:/var/www/html/berrymotes/js:ro
            - ./berrymotes/images:/var/www/html/berrymotes/images:ro
            - ./berrymotes/single_emotes:/var/www/html/berrymotes/single_emotes:ro
        ports:
            - '${HTTP_PORT}:${HTTP_PORT}/tcp'
            - '${HTTPS_PORT}:${HTTPS_PORT}/tcp'
            - '${LEGACY_SOCKET_PORT}:${LEGACY_SOCKET_PORT}/tcp'
        networks:
            - net
        depends_on:
            - php

    php:
        build: ./docker/php/
        image: registry.gitlab.com/berrytube/berrytube/php:latest
        restart: always
        environment:
            - DOMAIN
            - CDN_DOMAIN
            - SOCKET_DOMAIN
            - HTTP_PORT
            - HTTPS_PORT
            - LEGACY_SOCKET_PORT
        volumes:
            - ./web:/var/www/html/web:ro
            - ./berrymotes/data:/var/www/html/berrymotes/data:ro
            - ./berrymotes/css:/var/www/html/berrymotes/css:ro
            - ./berrymotes/js:/var/www/html/berrymotes/js:ro
        expose:
            - '9000'
        networks:
            - net
        depends_on:
            - mysql

    node:
        build: ./docker/node/
        image: registry.gitlab.com/berrytube/berrytube/node:latest
        command: node server.js
        restart: always
        expose:
            - '8344'
        networks:
            - net
        depends_on:
            - mysql

    mysql:
        image: mysql:8.0
        command: --default-authentication-plugin=mysql_native_password
        restart: always
        environment:
            MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
            MYSQL_DATABASE: berrytube
            MYSQL_USER: berrytube
            MYSQL_PASSWORD: berrytube
        volumes:
            - mysql:/var/lib/mysql
            - ./schema.sql:/docker-entrypoint-initdb.d/berrytube.sql:ro
        expose:
            - '3306'
        networks:
            - net
