version: '2'

networks:
    bt-net:

volumes:
    bt-caddy:

services:
    bt-caddy:
        build: ./docker/caddy/
        image: registry.gitlab.com/berrytube/berrytube/caddy:latest
        command: caddy -agree -log stderr -ca "${CA_URL}" -email "${CA_EMAIL}"
        restart: always
        environment:
            - DOMAIN
            - CDN_DOMAIN
            - HTTP_PORT
            - HTTPS_PORT
            - NODE_HTTP_PORT
            - NODE_HTTPS_PORT
        volumes:
            - bt-caddy:/root/.caddy
            - ./web:/var/www/html:ro
        ports:
            - '${HTTP_PORT}:${HTTP_PORT}/tcp'
            - '${HTTPS_PORT}:${HTTPS_PORT}/tcp'
            - '${NODE_HTTP_PORT}:${NODE_HTTP_PORT}/tcp'
            - '${NODE_HTTPS_PORT}:${NODE_HTTPS_PORT}/tcp'
        networks:
            - bt-net

    bt-php:
        build: ./docker/php/
        image: registry.gitlab.com/berrytube/berrytube/php:latest
        restart: always
        environment:
            - DOMAIN
            - CDN_DOMAIN
            - HTTPS_PORT
            - NODE_HTTPS_PORT
        volumes:
            - ./web:/var/www/html:ro
        expose:
            - '9000'
        networks:
            - bt-net

    bt-node:
        build: ./docker/node/
        image: registry.gitlab.com/berrytube/berrytube/node:latest
        command: node server.js
        restart: always
        expose:
            - '8344'
        networks:
            - bt-net

    bt-mysql:
        image: mysql:8.0
        command: --default-authentication-plugin=mysql_native_password
        restart: always
        environment:
            MYSQL_RANDOM_ROOT_PASSWORD: 'yes'
            MYSQL_DATABASE: berrytube
            MYSQL_USER: berrytube
            MYSQL_PASSWORD: berrytube
        volumes:
            - ./schema.sql:/docker-entrypoint-initdb.d/berrytube.sql:ro
            - ./database/:/var/lib/mysql
        expose:
            - '3306'
        networks:
            - bt-net
