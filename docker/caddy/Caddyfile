(tls_cloudflare) {
	tls {
		dns cloudflare
		must_staple
	}
}

(tls_http) {
	tls {
		must_staple
	}
}

(tls_existing) {
	tls {
		load "/existing-certs"
	}
}

(tls_self_signed) {
	tls self_signed
}

(common) {
	import mimes

    gzip
    realip cloudflare

    root /var/www/html/web

    log / stdout {combined} {
        except /ping.txt /ping.php /sha1/76fd81f2d5d91ab09c20dbe097b4bcda9a0e6c9b/ping.txt
    }

	import tls_{$TLS_TYPE}

    header / {
        Cache-Control "public, no-cache, must-revalidate"
        Expect-Ct "enforce; max-age=60; report-uri=\"https://atte.report-uri.com/r/d/ct/enforce\""
        Expect-Staple "max-age=60; report-uri=\"https://atte.report-uri.com/r/d/staple/reportOnly\"; includeSubDomains"
        Feature-Policy "accelerometer 'none'; ambient-light-sensor 'none'; autoplay *; camera 'none'; encrypted-media *; fullscreen *; geolocation 'none'; gyroscope 'none'; magnetometer 'none'; microphone 'none'; midi 'none'; payment 'none'; picture-in-picture *; speaker 'none'; usb 'none'; vibrate 'none'; vr 'none'"
        Referrer-Policy "strict-origin"
        Report-To "{\"group\":\"default\",\"max_age\":86400,\"endpoints\":[{\"url\":\"https://atte.report-uri.com/a/d/g\"}],\"include_subdomains\":true}"
        NEL "{\"report_to\":\"default\",\"max_age\":86400,\"include_subdomains\":true}"
        Strict-Transport-Security "max-age=60"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block; report=\"https://atte.report-uri.com/r/d/xss/enforce\""
        -Public-Key-Pins
        -Server
        -X-Powered-By
    }
}

http://{$DOMAIN}:{$HTTP_PORT},
http://www.{$DOMAIN}:{$HTTP_PORT} {
    import common

    fastcgi / php:9000 php

    redir {
        if {path} not_starts_with /api/
        / https://{$DOMAIN}:{$HTTPS_PORT}{uri}
    }

    templates /api/migrate_page.html
}

https://www.{$DOMAIN}:{$HTTPS_PORT} {
	import common

    root /dev/null
    redir / https://{$DOMAIN}:{$HTTPS_PORT}{uri}
}

https://{$DOMAIN}:{$HTTPS_PORT} {
    import common

    index index.php
    fastcgi / php:9000 php

    header /api/migrate_frame.html -X-Frame-Options
    templates /api/migrate_frame.html
}

https://cdn.{$DOMAIN}:{$HTTPS_PORT} {
    import common

    status 404 /404
    rewrite / {
        if {file} ends_with .html
        if {file} ends_with .php
        if {path} is /
        if_op or
        to /404
    }

    rewrite /sha1/ {
        regexp ^/[^/]+/(.+)$
        to /sha1/{1}
    }

    header / {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "OPTIONS, HEAD, GET"
        Access-Control-Max-Age "600"
    }

    # 1 month, stale while revalidate 1 day
    header /plugins/toastthemes/ Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
    header /berrymotes/ Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
    header /images/ Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
    header /sounds/ Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"

    # 1 hour, stale while revalidate 1 minute
    header /berrymotes/data/ Cache-Control "public, max-age=3600, stale-while-revalidate=60"

    # 1 year, stale while revalidate 1 month, never changes
    header /sha1/ Cache-Control "public, max-age=31557600, stale-while-revalidate=2592000, immutable"
}

http://:{$LEGACY_SOCKET_PORT},
https://socket.{$DOMAIN}:{$HTTPS_PORT} {
    import common

    tls {
        alpn http/1.1
    }

    header / {
        Access-Control-Allow-Origin "*"
        Access-Control-Allow-Methods "OPTIONS, HEAD, GET"
        Access-Control-Max-Age "600"
        -X-Frame-Options
    }

    proxy / http://node:8344 {
        transparent
        websocket
    }
}

https://btc.{$DOMAIN}:{$HTTPS_PORT} {
    import common

    index index.html index.htm index.txt index.php
    fastcgi / extra-php:9000 php

    root /var/www/html/extra

    proxy /berrymotes/ https://{$DOMAIN}:{$HTTPS_PORT} {
        header_upstream X-Real-IP {remote}
        header_upstream X-Forwarded-For {remote}
        header_upstream X-Forwarded-Proto {scheme}
    }
}

https://socket.btc.{$DOMAIN}:{$HTTPS_PORT} {
    import common

    tls {
        alpn http/1.1
    }

    header / {
        Access-Control-Allow-Origin {>Origin}
        Access-Control-Allow-Methods "OPTIONS, HEAD, GET"
        Access-Control-Allow-Credentials true
        Access-Control-Max-Age 600
        -X-Frame-Options
    }

    rewrite / /{?app}/{path}

    proxy /ponypen/ http://{$DOMAIN}:9990 {
        without /ponypen/
        transparent
        websocket
    }

    proxy /canvas/ http://{$DOMAIN}:9991 {
        without /canvas/
        transparent
        websocket
    }

    proxy /shotbutton/ http://{$DOMAIN}:9992 {
        without /shotbutton/
        transparent
        websocket
    }
}

# for Docker healthcheck
http://localhost:1234 {
    import common
}
